<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Pedido</title>
  <style>
    body {
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    form {
      background: #e0e0e0;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
    }
    button {
      background: #007bff;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

  <form id="pedidoForm">
    <h2>Formulario de Pedido</h2>

    <label>Nombre *</label>
    <input type="text" name="NAME" required />

    <label>Apellidos *</label>
    <input type="text" name="LAST_NAME" required />

    <label>Celular *</label>
    <input type="tel" name="PHONE" placeholder="+51999999999" value="" required />

    <label>Correo *</label>
    <input type="email" name="EMAIL" required />

    <label>Rubro</label>
    <input type="text" name="UF_CRM_RUBRO" />

    <label>Dirección</label>
    <input type="text" name="ADDRESS" />

    <label>Mensaje</label>
    <textarea name="COMMENTS"></textarea>

    <!-- Campo oculto: aquí irán los productos -->
    <input type="hidden" name="UF_CRM_1754419967" id="productosInteres" />
    <input type="hidden" name="SOURCE_ID" value="WEB" />
    <!-- Autorización de datos -->
    <div class="form-input">
      <label>
        <input type="checkbox" id="autorizacion" checked required>
        Autorizo a Packplus Perú el uso de mis datos personales para recibir información de sus productos.
      </label>
    </div>
    <button type="submit" >Enviar pedido</button>
  </form>

  <script>
   
    // Ejemplo de productos:
    const productos = [
      { nombre: "Producto A", cantidad: 2, total: 100 },
      { nombre: "Producto B", cantidad: 1, total: 50 }
    ];

    const productosTexto = productos
      .map(p => `${p.nombre} x${p.cantidad} - S/ ${p.total}`)
      .join("\n");

    // Enviamos los productos al campo oculto
    document.getElementById("productosInteres").value = productosTexto;

    // 🚀 Envío del form a Bitrix
    document.getElementById("pedidoForm").addEventListener("submit", async function(e){
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {};
      formData.forEach((value, key) => data[key] = value);

      // Ajustamos formatos
      //data.PHONE = [{ VALUE: "+51" + data.PHONE, VALUE_TYPE: "WORK" }];
      data.EMAIL = [{ VALUE: data.EMAIL, VALUE_TYPE: "WORK" }];

      // Asignación aleatoria entre 2 responsables
      const responsables = [273, 447]; // IDs reales de Bitrix
      const responsableId = responsables[Math.floor(Math.random() * responsables.length)];
      data.ASSIGNED_BY_ID = responsableId;

      // Envio a Bitrix24
      const response = await fetch("https://packplusperu.bitrix24.com/rest/13/hundco8a3n74oa3r/crm.lead.add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fields: data })
      });

      const result = await response.json();
      if (result.error) {
        alert("Error: " + result.error_description);
      } else {
        alert("Pedido enviado correctamente a Bitrix 🎉");
        e.target.reset();
        window.location.href = "https://packplusperu.pe/productos/"
      }
    });
  </script>

</body>
</html>
